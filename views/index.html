<!doctype html>
<html lang="ja" ng-app="app">
<head>
  <meta charset="utf-8">
  <title>ユーザー管理</title>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <link rel="stylesheet" href="css/index.css" >

  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src="//code.angularjs.org/1.3.15/angular.min.js"></script>
  <script src="//code.angularjs.org/1.3.15/angular-resource.min.js"></script>
  <script src="//code.angularjs.org/1.3.15/angular-route.min.js"></script>
</head>
<body id="register">
  <div class="container">
    <div ng-view></div>
  </div>
  <script>
    var app = angular.module('app', ['ngResource', 'ngRoute']);

    app.config(function($routeProvider) {
      $routeProvider.when('/users', {
        templateUrl: 'list.html', controller: 'ListCtrl'
      }).when('/users/:_id', {
        templateUrl: 'edit.html', controller: 'EditCtrl'
      }).when('/reserves/users/:_id', {
        templateUrl: 'reserve/reserves.html', controller: 'ReserveCtrl'
      }).otherwise({
        redirectTo: '/users'
      });
    });

    app.factory('User', function($resource) {
      return $resource('/api/users/:_id');
    });
    app.factory('Reserve', function($resource) {
      return $resource('/api/reserves/users/:_id');
    });

    app.controller('ListCtrl', function($scope, $route, User) {
      $scope.users = User.query();
      $scope.delete = function(_id) {
        User.delete({_id: _id}, function() {
          $route.reload();
        });
      };
    });

    app.controller('EditCtrl', function($scope, $routeParams, $location, User) {
      if ($routeParams._id != 'new') {
        $scope.user = User.get({_id: $routeParams._id});
      }
      $scope.edit = function() {
        User.save($scope.user, function() {
          $location.url('/');
        });
      };
    });

    app.controller('ReserveCtrl', function($scope, $routeParams, $location, $filter, $q, User, Reserve) {
      if ($routeParams._id != 'new') {
        $scope.user = User.get({_id: $routeParams._id});
      }
      $q.all([Reserve.query({_id: $routeParams._id}).$promise]).then(function(result) {
        $scope.reserves = result[0];
        console.log('reserves:' + $scope.reserves);
        $scope.dates = [];
        var today = new Date();
        var day = angular.copy(today);
        for(var i = 0 ; i < 5; i++) {
          console.log('date: ' + day);
          var dateString = parseInt($filter('date')(day,'yyyyMMdd',today.getTimezoneOffset()), 10);
          console.log('dateString:' + dateString );
          var reserve = undefined;
          angular.forEach($scope.reserves, function(r, j) {
            if(r.date == dateString) {
              console.log('r.date:' + r.date );
              reserve = r;
            }
          })
          if(!reserve) {
            reserve = {
              date : dateString,
              owner: $routeParams._id
            };
          }
          $scope.dates.push(angular.copy(reserve));
          day.setDate(day.getDate() + 1);

        }
      })

      $scope.update = function(date, status) {
        date.status = status;
        Reserve.save({_id: $routeParams._id, reserve: date}, function() {
        });
      }
    });
  </script>
</body>
</html>
